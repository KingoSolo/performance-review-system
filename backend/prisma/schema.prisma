// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  ADMIN
  MANAGER
  EMPLOYEE
}

enum ReviewCycleStatus {
  DRAFT
  ACTIVE
  COMPLETED
}

enum ReviewType {
  SELF
  MANAGER
  PEER
}

enum ReviewStatus {
  NOT_STARTED
  DRAFT
  SUBMITTED
}

enum ReviewerType {
  MANAGER
  PEER
}

enum QuestionType {
  RATING
  TEXT
  TASK_LIST
}

// ============================================================================
// MODELS
// ============================================================================

model Company {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users        User[]
  teams        Team[]
  reviewCycles ReviewCycle[]
  questions    Question[]

  @@map("companies")
}

model User {
  id                       String   @id @default(cuid())
  companyId                String   @map("company_id")
  name                     String
  email                    String
  password                 String
  role                     UserRole @default(EMPLOYEE)
  managerId                String?  @map("manager_id")
  notificationPreferences  Json?    @map("notification_preferences")
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  // Relations
  company               Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  manager               User?                @relation("ManagerToEmployee", fields: [managerId], references: [id], onDelete: SetNull)
  directReports         User[]               @relation("ManagerToEmployee")
  teamMemberships       TeamMember[]
  reviewsAsEmployee     Review[]             @relation("EmployeeReviews")
  reviewsAsReviewer     Review[]             @relation("ReviewerReviews")
  assignmentsAsEmployee ReviewerAssignment[] @relation("EmployeeAssignments")
  assignmentsAsReviewer ReviewerAssignment[] @relation("ReviewerAssignments")

  @@unique([companyId, email])
  @@index([companyId])
  @@index([managerId])
  @@index([email])
  @@map("users")
}

model Team {
  id        String   @id @default(cuid())
  companyId String   @map("company_id")
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  company Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  members TeamMember[]

  @@index([companyId])
  @@map("teams")
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String   @map("team_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

model ReviewCycle {
  id        String            @id @default(cuid())
  companyId String            @map("company_id")
  name      String
  startDate DateTime          @map("start_date")
  endDate   DateTime          @map("end_date")
  status    ReviewCycleStatus @default(DRAFT)
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  // Relations
  company             Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  reviewConfigs       ReviewConfig[]
  reviews             Review[]
  reviewerAssignments ReviewerAssignment[]

  @@index([companyId])
  @@index([status])
  @@index([companyId, status])
  @@map("review_cycles")
}

model ReviewConfig {
  id            String     @id @default(cuid())
  reviewCycleId String     @map("review_cycle_id")
  stepNumber    Int        @map("step_number")
  reviewType    ReviewType @map("review_type")
  startDate     DateTime   @map("start_date")
  endDate       DateTime   @map("end_date")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  reviewCycle ReviewCycle @relation(fields: [reviewCycleId], references: [id], onDelete: Cascade)

  @@unique([reviewCycleId, stepNumber])
  @@index([reviewCycleId])
  @@map("review_configs")
}

model Question {
  id         String       @id @default(cuid())
  companyId  String       @map("company_id")
  reviewType ReviewType   @map("review_type")
  type       QuestionType @default(RATING)
  text       String
  maxChars   Int?         @map("max_chars")
  order      Int          @default(0)
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  // Relations
  company Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  answers Answer[]

  @@index([companyId])
  @@index([companyId, reviewType])
  @@index([companyId, reviewType, order])
  @@map("questions")
}

model Review {
  id            String       @id @default(cuid())
  reviewCycleId String       @map("review_cycle_id")
  employeeId    String       @map("employee_id")
  reviewerId    String       @map("reviewer_id")
  reviewType    ReviewType   @map("review_type")
  status        ReviewStatus @default(NOT_STARTED)
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  // Relations
  reviewCycle ReviewCycle @relation(fields: [reviewCycleId], references: [id], onDelete: Cascade)
  employee    User        @relation("EmployeeReviews", fields: [employeeId], references: [id], onDelete: Cascade)
  reviewer    User        @relation("ReviewerReviews", fields: [reviewerId], references: [id], onDelete: Cascade)
  answers     Answer[]

  @@unique([reviewCycleId, employeeId, reviewerId, reviewType])
  @@index([reviewCycleId])
  @@index([employeeId])
  @@index([reviewerId])
  @@index([reviewCycleId, status])
  @@index([reviewCycleId, employeeId])
  @@map("reviews")
}

model Answer {
  id         String   @id @default(cuid())
  reviewId   String   @map("review_id")
  questionId String   @map("question_id")
  rating     Int?     // 1-5 or null for text-only questions
  textAnswer String?  @map("text_answer")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  review   Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([reviewId, questionId])
  @@index([reviewId])
  @@index([questionId])
  @@map("answers")
}

model ReviewerAssignment {
  id            String       @id @default(cuid())
  reviewCycleId String       @map("review_cycle_id")
  employeeId    String       @map("employee_id")
  reviewerId    String       @map("reviewer_id")
  reviewerType  ReviewerType @map("reviewer_type")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  // Relations
  reviewCycle ReviewCycle @relation(fields: [reviewCycleId], references: [id], onDelete: Cascade)
  employee    User        @relation("EmployeeAssignments", fields: [employeeId], references: [id], onDelete: Cascade)
  reviewer    User        @relation("ReviewerAssignments", fields: [reviewerId], references: [id], onDelete: Cascade)

  @@unique([reviewCycleId, employeeId, reviewerId, reviewerType])
  @@index([reviewCycleId])
  @@index([employeeId])
  @@index([reviewerId])
  @@index([reviewCycleId, employeeId])
  @@map("reviewer_assignments")
}
